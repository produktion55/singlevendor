
      if (!productId || !userId || !formBuilderData) {
        return res.status(400).json({ 
          success: false, 
          error: "Missing required fields" 
        });
      }

      // Get product details
      const product = await storage.getProduct(productId);
      if (!product || product.category !== "generator" || !product.formBuilderJson) {
        return res.status(400).json({ 
          success: false, 
          error: "Invalid generator product" 
        });
      }

      // Validate form data against schema
      const schema = product.formBuilderJson as any;
      const validation = validateFormData(formBuilderData, schema);
      
      if (!validation.valid) {
        return res.status(400).json({ 
          success: false, 
          errors: validation.errors 
        });
      }

      // Calculate dynamic price
      const basePrice = parseFloat(product.price.toString());
      const totalPrice = calculateDynamicPrice(formBuilderData, schema, basePrice);

      // Create an order for the generation request
      const order = await storage.createOrder({
        userId,
        productId,
        quantity: 1,
        totalAmount: totalPrice,
        status: "processing",
        orderData: {
          generatorType: product.title,
          formBuilderData,
          fileReady: false
        }
      });

      // Trigger webhook to external service
      await handleGeneratorWebhook(
        { body: { orderId: order.id, userId, productId } } as any,
        res
      );

      console.log(`Form builder generation request created: ${order.id}`);

    } catch (error) {
      console.error("Form builder generation error:", error);
      res.status(500).json({ 
        success: false, 
        error: "Failed to submit generation request" 
      });
    }
  });

  // Form Builder Generator Callback Endpoint
  app.post("/api/webhook/generator-complete", handleGeneratorCallback);

  // Validate Form Builder Data Endpoint
  app.post("/api/validate-formbuilder", async (req, res) => {
    try {
      const { productId, formData } = req.body;

      if (!productId || !formData) {
        return res.status(400).json({ 
          success: false, 
          error: "Missing productId or formData" 
        });
      }

      const product = await storage.getProduct(productId);
      if (!product || !product.formBuilderJson) {
        return res.status(404).json({ 
          success: false, 
          error: "Product not found or has no form configuration" 
        });
      }

      const validation = validateFormData(formData, product.formBuilderJson as any);
      
      res.json({
        success: validation.valid,
        errors: validation.errors
      });

    } catch (error) {
      console.error("Form validation error:", error);
      res.status(500).json({ 
        success: false, 
        error: "Failed to validate form data" 
      });
    }
  });

  // Calculate Dynamic Price Endpoint
  app.post("/api/calculate-price", async (req, res) => {
    try {
      const { productId, formData } = req.body;

      if (!productId) {
        return res.status(400).json({ 
          success: false, 
          error: "Missing productId" 
        });
      }

      const product = await storage.getProduct(productId);
      if (!product) {
        return res.status(404).json({ 
          success: false, 
          error: "Product not found" 
        });
      }

      const basePrice = parseFloat(product.price.toString());
      
      if (product.formBuilderJson && formData) {
        const totalPrice = calculateDynamicPrice(formData, product.formBuilderJson as any, basePrice);
        res.json({
          success: true,
          basePrice,
          totalPrice,
          additionalPrice: totalPrice - basePrice
        });
      } else {
        res.json({
          success: true,
          basePrice,
          totalPrice: basePrice,
          additionalPrice: 0
        });
      }

    } catch (error) {
      console.error("Price calculation error:", error);
      res.status(500).json({ 
        success: false, 
        error: "Failed to calculate price" 
      });
    }
  });

  });

  // MediaMarkt Generator API
  app.post("/api/generate-mediamarkt", async (req, res) => {
    try {
      const { formData, userId } = req.body;

      // Create an order for the generation request
      const order = await storage.createOrder({
        userId,
        productId: "prod-6", // MediaMarkt product
        quantity: 1,
        totalAmount: 12.99,
        status: "processing",
        orderData: {
          generatorType: "mediamarkt-rechnung",
          formData,
          fileReady: false
        }
      });

      // In a real implementation, this would trigger a webhook to external service
      // For now, we'll simulate the process
      console.log(`MediaMarkt generation request created: ${order.id}`);
      
      // Simulate webhook call to external Windows server
      const webhookPayload = {
        orderId: order.id,
        userId,
        productSlug: "mediamarkt-rechnung",
        formData,
        callbackUrl: `${req.protocol}://${req.get('host')}/api/webhook/mediamarkt-complete`
      };
      
      console.log("Webhook payload (would be sent to external server):", webhookPayload);

      res.json({ 
        success: true, 
        orderId: order.id,
        message: "Generation request submitted successfully"
      });
    } catch (error) {
      console.error("MediaMarkt generation error:", error);
      res.status(500).json({ 
        success: false, 
        error: "Failed to submit generation request" 
      });
    }
  });

  // Webhook endpoint for external service to upload completed files
  app.post("/api/webhook/mediamarkt-complete", async (req, res) => {
    try {
      const { orderId, userId, filename, fileBuffer } = req.body;

      if (!orderId || !userId || !fileBuffer) {
        return res.status(400).json({ error: "Missing required fields" });
      }

      // Verify the order exists and belongs to the user
      const order = await storage.getOrder(orderId);
      if (!order || order.userId !== userId || order.productId !== "prod-6") {
        return res.status(404).json({ error: "Order not found" });
      }

      // Update order with file ready status
      await storage.updateOrder(orderId, {
        status: "delivered",
        deliveredAt: new Date(),
        orderData: {
          ...(order.orderData || {}),
          fileReady: true,
          filename: `mediamarkt-rechnung_${userId}_${orderId}.png`
        }
      });

      console.log(`MediaMarkt invoice generated: mediamarkt-rechnung_${userId}_${orderId}.png`);

      res.json({ success: true, message: "File processed successfully" });
    } catch (error) {
      console.error("Webhook error:", error);
      res.status(500).json({ error: "Failed to process webhook" });
    }
  });

  // File download endpoint with access control (simple mock for development)
  app.get("/api/download/:filename", async (req, res) => {
    try {
      const { filename } = req.params;
      
      // Parse filename to extract user ID for verification
      const parts = filename.split('_');
      if (parts.length < 3) {
        return res.status(400).json({ error: "Invalid filename format" });
      }

      // For development, we'll just return a success response
      // In production, this would stream the actual file from object storage
      res.json({ 
        message: "File download would start here", 
        filename,
        note: "This is a development endpoint. In production, the actual PNG file would be downloaded."
      });
      
    } catch (error) {
      console.error("Download error:", error);
      res.status(500).json({ error: "Failed to download file" });
    }
  });

  // Notification routes
  app.get("/api/notifications/user/:userId", async (req, res) => {
    try {
      const notifications = await storage.getNotificationsByUserId(req.params.userId);
      res.json(notifications);
    } catch (error) {
      console.error("Get notifications error:", error);
      res.status(500).json({ message: "Failed to fetch notifications" });
    }
  });

  app.get("/api/notifications/user/:userId/unread-count", async (req, res) => {
    try {
      const count = await storage.getUnreadNotificationCount(req.params.userId);
      res.json({ count });
    } catch (error) {
      console.error("Get unread count error:", error);
      res.status(500).json({ message: "Failed to fetch unread count" });
    }
  });

  app.patch("/api/notifications/:id/read", async (req, res) => {
    try {
      const notification = await storage.markNotificationAsRead(req.params.id);
      if (!notification) {
        return res.status(404).json({ message: "Notification not found" });
      }
      res.json(notification);
    } catch (error) {
      console.error("Mark notification read error:", error);
      res.status(400).json({ message: "Failed to mark notification as read" });
    }
  });

  app.patch("/api/notifications/user/:userId/read-all", async (req, res) => {
    try {
      await storage.markAllNotificationsAsRead(req.params.userId);
      res.json({ success: true });
    } catch (error) {
      console.error("Mark all notifications read error:", error);
      res.status(400).json({ message: "Failed to mark all notifications as read" });
    }
  });

  const httpServer = createServer(app);
  return httpServer;
}
